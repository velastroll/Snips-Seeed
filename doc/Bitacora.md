# üß† What i'm doing

## Init day

Se obtuvo el dispositivo asisente, pero al parecer no detectaba la voz.
Se cre√≥ un asistente llamado _HeyJulia_ con el idioma ingl√©s, que inclu√≠a la aplicaci√≥n _AytoSanVicente_.
Esta app estaba compuesta por un _intent_ llamado 'contacto' que conten√≠a los slots de `fax`, `telefono` y `email`. 
Se instal√≥ este proyecto en el dispositivo a trav√©s de la herramienta **sam**, y se hizo la prueba.

El asistente detectaba bien el intent, al igual que los slots. 

Intento conectar el asistente con el repositorio, pero introduzco el repositorio en la carpeta incorrecta.

---

## Martes 1 de Octubre

Tras una reuni√≥n, el tutor JVegas informa acerca de que es al propio asistente desde la consola de snips, desde donde hay que asignar a la aplicaci√≥n creada una seria de acciones, vinculando la direcci√≥n del repositorio alojado en GitHub.

Tras seguir los pasos, el asistente responde bien a los frases que se le asignan a las acciones de cuando detecta cierto intent, pero no a la de los slots.

Tras merodear y probar, pensaba que se acced√≠a a los slots siguiendo una estructura como la siguiente o similar:

`name = intentMessage.slots[i].raw_value`

Pero no, los slots se convierten en clave en pares diccionario valor, de modo que se accede de la siguiente forma:

`slot = intentMessage.slots.nombreDelSlot`

Tras esto, el asistente funciona, pero el √∫nico fallo que le queda es que la voz tiene acento ingl√©s y lee los n√∫meros en ese idioma, lo que no nos es √∫til.

---

## Miercoles 2 de Octubre y Jueves 3 de Octubre

Procedemos a crear otro asistente nuevo, pero este que hable en castellano.
Seguimos los pasos anteriores y lo cargamos en el dispositivo.
El asistente detecta nuestras voces, pero no consigue hacer el reconocimiento de las frases: El skill snips-nlu no funciona.
_snips-nlu: natural language understanding_
Tras varios posibles casos, vemos 3 posibles causas:

- El nuevo asistente est√° en castellano, y anteriormente estaba en ingl√©s, por lo que puede haber una confrontaci√≥n:

Tras varias pruebas, no se consigue estar en lo cierto, ya vuelve a empezar con el projecto en ingl√©s, y seguimos con el mismo fallo. (si antes funcionaba as√≠, ¬øpor qu√© ya no? Posible inestabilidad de snips)
Esta opci√≥n se acaba desechando, ya que JVegas confirma que √©l en el pasado consigui√≥ que hablase en castellano.

- Otra opci√≥n, pod√≠a ser la inclusi√≥n de varios slots que no siguen un tipo predefinido, si no que son custom, en un mismo intent que no interaccionen entre ellos. Pero tambi√©n se desecha ya que seconsigui√≥ hacerlo funcionar en el pasado, y probando con un solo intent de un solo slot, tampoco funciona.
- La tercera opci√≥n es que el asistente desarrollado en la consola de snips est√© funcionando en una version superior que la que tenemos instalada en el dispositivo, de modo que los skills instalados no sean compatibles.
Esta opci√≥n coge sentido al mirar los logs del servicio de snips-nlu, ya que informa acerca de que el asistente necesita la v0.20.0 y se est√° corriendo la 0.19.0.

Volvemos a bajar la imagen de Snips-Seeed, la volvemos a cargar, la actualizamos y vemos datos positivos: Al actualizarla, la version de snips es la 0.64.0, y hace un rato ten√≠amos la 0.63.5.

Nos metemos a ver las versiones de Snips y vemos que evidentemente acaba de salir una nueva release, y que posiblemente el asistente estuviese fallando porque antes no estaba disponible para nosotros la actualizaci√≥n.

Lo dejamos actualizando, ya que tarda demasiado. (+30min)

---

## Viernes 4 de Octubre

El tutor JVegas me informa de que ahora ya ha conseguido levantar el servicio de snips-nlu. ¬°Buenas noticias!
Deja rastro de la secuencia seguida:

``` Bash
tras actualizar snips: todos los servicios arriba excepto analytics
> $ sam reboot
.... sin snips-audio-server

> $ sam test microphone
... sin tarjeta sonido

$ sam setup-audio
.... configura tarjeta sonido

$ sam status
... todos arriba (sin analytics )

$ sam update-assistan
... asistente actualizado con los mismos avisos de version de pip

$ sam status
.... servicio snips-skill-server caido. Visto el log parece que tiene problemas de acceso a /dev/spidev0.0 , le cambio el permiso

$ sudo chmod +r /dev/spidev0.0

$ sam service start snips-skill-server
.... servicio arriba

.... pruebo el asistente y FUNCIONA!!!!
```

Tras recibir el prototipo del tutor, procedo a probar con mi asistente creado anteriormente, en castellano y con diversos slots del mismo tipo en un √∫nico intent. Resultado: funciona perfectamente.
Al parecer, el problema era ese, que nuestro prototipo ten√≠a una version que a√∫n no habia sido actualizada porque no hab√≠a sido desplegada, y no funcionaba con el asistente, que s√≠ que hab√≠a sido actualizado.

---

## S√°bado 5 de Octubre

Insertamos en el asistente m√°s posibles casos, al igual que se obtiene la cuenta de la consola de snips a trav√©s de la chach√©: de esta forma, podemos modificar todos la cuenta de todos los actions que creemos desde el mismo fichero, ahorr√°ndonos trabajo.
Se ha cambiado el hotword de "Hey snips" por "Pregonero", siguiento la [documentaci√≥n](https://docs.snips.ai/articles/platform/wakeword/personal) de la web.
Tras realizar los pasos se ha conseguido que detecte la esta palabra para levantarse una vez de 15 intentos, por lo que no es viable.

Se proceder√° a intentar de nuevo la configuraci√≥n en un espacio m√°s aislado y con una mejor vocalizaci√≥n.

En caso de obtener los mismos resultado, se proceder√° a seguir un [enlace externo](https://help.github.com/en/articles/basic-writing-and-formatting-syntax#links) con el que tambi√©n se puede configurar el hotword.

---

## Domingo 6 de Octubre

Se procedi√≥ a instalar en el asistente el hotword no oficial, entrenando al asistente con varias voces de distintos g√©neros, pero no se fue capaz de dejarlo funcionando.
Hay que probar de nuevo siguiendo todos los pasos sin tener ninguna versi√≥n de snips instalada en la tarjeta SD, pero para ello hay que realizar una copia de seguridad de el dispositivo ya funcionando.

Despu√©s, se vovli√≥ a instalar el hot word de manera oficial, pero esta vez respond√≠a a la secuencia _"Hey pregonera"_, aunque con un ratio bajo tambi√©n. Se le subi√≥ la sensibilidad hasta 0.7, algo que no es recomendado ya que los valores deben ir entre 0.4 y 0.6, y su ratio de aciertos aument√≥ 3/5, pero con secuencias de golpes de la misma intensitad, el asistente tambi√©n responde.
Puede valer como prototipo, pero **NO** para producci√≥n, por eso es importante hacer funcionar la manera no-oficial.

---

## Jueves 10 de Octubre

Se ha intentado configurar el modem con la tarjeta de datos pero sin conseguir que funcionase.
Hablar con JVegas para ver si est√° activada, o qu√© puede ser.

---

## Viernes 11 de Octubre

LA tarjeta sim no estaba activada. Recibo por rocket los valores para activarla, aunque a√∫n no se ha configurado ni probado.

---

## Domingo 13 de Octubre

Probamos a reinstalar todo en la raspberry:

1. Instalamos la versi√≥n Raspbian Stretch Lite: la versi√≥n buster no es compatible con snips ni con el customHotword.
2. Configuramos el hotword siguiendo los pasos.
3. Instalamos snips a trav√©s de sam.
4. Configuramos los valores del asistente de audio con la siguiente configuraci√≥n:
**/etc/asound.conf**:

``` vim
pcm.!default {
    type asym
    playback.pcm {
        type plug
        slave.pcm "hw:1,0"
    }
    capture.pcm "multi"
}

pcm.multi {
    type plug
    slave.pcm "multiapps"
}

pcm.multiapps {
    type dsnoop
    slave.pcm "hw:1,0"
    ipc_key 666666
}
```

Hay que tener cuidado, ya que al instalar de vez en cuando la tarjeta de audio, este archivo vuelve a su configuraci√≥n inicial, de modo que deja de escucharnos, por lo que hay que volver a ponerle esta configuraci√≥n.

_Tip: Puede ser interesante meterle un script de modo que si al actualizar remotamente el asistente, se vuelva a esta configuraci√≥n en vez de a la de por defecto._

---

## Martes 15 de Octubre

Se procede a crear el core del backend que ir√° en el servidor.

Para ello, intento acceder al servidor que nos proporciona la escuela, pero sin √©xito, por lo que mando un correo a los t√©cnicos de la escuela para ver si me lo pueden solucinar.

Mientras tanto, trabajo en local:

- Investigo c√≥mo se puede obtener una p√°gina a trav√©s de kotlin, que es el lenguaje que voy a utilizar para crear los servicios REST, y veo que un buen parseador de datos es KSoup.
Tras un rato con KSoup, veo que tiene las opciones un poco limitadas ya que est√° a√∫n muy verde y en fase de pruebas, por lo que tiendo a utiliazr JSoups, que es de d√≥nde deriva KSoup y es compatible con Kotlin, ya que es el predecesor en Java.
- Tras realizar las peticiones, consigo obtener los datos a traves de un filtrado del documento obtenido con JSoup, de modo que hago primero un filtrado por `div`, y posteriormente por diferentes etiquetas css, como son `phone`, `address`, etc.
- Creo un servicio REST en el servidor, configurando como content negotiation a GSon.
Como alternativa a GSon tenemos JAckson, pero prefiero utilizar GSon ya que los valores nulos no los env√≠a, algo que nos va a ser √∫til, mientras que Jackson los enviar√≠a como null.
Activo el prettyPrinting de GSon que simplemente har√° que si imprimimos el JSon, tendr√° una mejor visualizaci√≥n:

``` Kotlin
   // JSon converter
    install(ContentNegotiation) {
        gson {
            setPrettyPrinting()
        }
    }
```

- y compruebo que procesa bien la p√°gina:

``` zsh
‚ñ∂ curl localhost:8082/test
{
  "address": {
    "name": "Ayuntamiento de San Vicente del Palacio",
    "street": "Plaza Mayor, 1.",
    "postalcode": "47493",
    "city": "San Vicente del Palacio. Valladolid"
  },
  "telephone": "+34 983 825 006",
  "fax": "+34 983 825 056",
  "email": "ayuntamiento@sanvicentedelpalacio.gob.es",
  "urlExterna": "http://sanvicentedelpalacio.gob.es"
}
```

---

## Miercoles 16 de Octubre

Esto va cogiendo forma.
La parte del backend ten√≠a una estructura muy poco limpia, por lo que el rato de la tarde de hoy lo gastamos en darle una forma m√°s escalable a todo el sistema, de forma que creamos un controlador llamado `Retriever`, que en su construcci√≥n recibe un enum que representa a un pueblo, o servicio del que queremos recibir la informaci√≥n. En funci√≥n del enum recibido, hace la petici√≥n y procesa toda la informaci√≥n.
Dentro de ese procesamiento, est√° preparado para poder recabar en un futuro toda la informaci√≥n: Ya sea sobre el ayuntamiento, o diferentes establecimientos del pueblo, estando todo muy bien preparado para una futura expansi√≥n.
Ya tendr√≠amos una buena base.

Me pongo a investigar sobre posibles utilidades de Snips.
Veo que existe un repositorio donde se comunican con el dispositivo de manera escrita, evitando decir la palabra. Esto podr√≠a ser muy √∫til a la hora de poder cambiar su arquitectura y conseguir mantener una conversacion:

- Actualmente solo se puede hacer esto:
    1. Usuario: [hotword]
    2. Dispositivo: Escucha
    3. Usuario: Dice lo que sea.
    4. Dispositivo: responde y vuelve a esperar hasta que escucha el hotword.

De modo que se podr√≠a intentar que dependiendo de la informaci√≥n que haya dicho el usuario, el dispositivo entre en un estado en el que responda, ejecute para s√≠ mismo [hotword] y se ponga a escuchar. Entonces, en la respuesta del dispotivo podr√≠a preguntar algo al usuario, y mantenerse escuchando a la respuesta del usuario, repitiendo el proceso y manteniendo una conversaci√≥n, por ejemplo, de configuraci√≥n.

Este proceso ser√≠a muy laborioso pero muy interesante.

---

## Jueves 17 de Octubre

Reuni√≥n con el tutor JVegas:
MAntenemos una interesante reuni√≥n en la que vamos dando nuestra visi√≥n sobre el proyecto y sobre qu√© puntos habr√≠a que reforzar, en cual meter mano, y cual es necesario que sea el proyecto final que deber√≠a entregar.
Al final quedamos en que ser√≠a muy bueno que a la hora de presentar el prototipo, fuese eso, un prototipo, de modo que dejase toda la base funcionando ya sea en servidor, en el dispositivo, y en la web. De esta forma, otra persona podr√≠a seguir con el TFG en otro periodo lectivo.

- Requisitos m√≠nimos:
    1. El servidor, recopila informaci√≥n y la actualiza cada X tiempo, de modo que cuando le pregunta el dispoitivo para obtener una cach√© con todo, el servidor ya la tiene preparada.
    2. Conseguir comunicar el dispositivo con el servidor.
    3. Establecer una llamada cada 5 minutos por parte del dispositivo hacia el servidor, para saber si el estado del dispositivo.
    4. Guardar en el dispositivo diferentes estad√≠sticas sobre su uso, que ser√°n enviadas al servidor.
    5. Enviar las estad√≠sticas al servidor.
    6. Cifrar las peticiones, de modo que nadie pueda falsear los datos.

- Expandiendo la base:
    1. Cuando se inicie el despositivo, que diga unas palabras: √∫til para saludar, y explicar sus funciones. ¬øTiene configurado el wifi? Ya conoce esa casa, no hace falta que hable.
    2. Permitir que el servidor se comunique con el dispositivo: En las respuesta al `I'm alive` se puede intentar meter qu√© quiere el servidor que haga el dispositivo, como reiniciarse, por ejemplo.
    3. Procesar en el dispositivo las acciones que quiere el servidor que realice, hacerlas, y avisar si se han hecho correctamente.
    4. Conseguir un di√°logo Usuario/dispositivo, por b√°sico que fuese, ya que establecer√≠amos una conversaci√≥n un una muy buena base para la siguiente person que quiera tratar con este proyecto.
    5. Si se ha conseguido la conversaci√≥n, establecer las pautas para poder configurar una conexi√≥n al wifi de una casa.

En la charla, el dispositivo no consigue levantar el servicio del audio, lo que nos da dolor de cabeza por la aparente inestabilidad del dispositivo, y una reinstalaci√≥n de la tarjeta de audio en cada reinicio del dispositivo.

Al llegar a casa, vuelve a funcionar bien sin hacer nada. Se investiga acerca de las posibles causas, ya fuese por la conexi√≥n o no a internet, pero no se consigue que vuelva a fallar. El fallo, por tanto, puede haber sido debido a que la fuente de alimentaci√≥n no tuviese el voltaje necesario. as√≠ que habr√≠a que probar de nuevo en un futuro, en el despacho del profesor con su fuente de alimentaci√≥n.

---

## Viernes 18 de Octubre

Se ha intentado buscar informaci√≥n acerca de OAuth y para ver como funciona.

Para permitir la conexi√≥n OAuth, se necesitan 3 partes:

- Dispositivo que se quiere conectar.
- Servidor cliente, con quien se conecta el dispositivo.
- Servidor OAuth, quien mantiene todo el registro de los tokens y permite su acceso a diferentes servidores clientes.

Para enterarnos: PAra nuestro sistema ponemos un servidor OAuth, y para acceder a √©l y gestionar los tokens, es necesario registrarse con un servidor cliente. El servidor cliente puede ser Spotify, FB, ..., o uno propio. En este caso vamos a utilizar uno propio.

Al utilizar el framework de Ktor, nos viene la opci√≥n de configurar las credenciales OAuth, pero esta opcion que nos da es la de gestionar el servidores clientes.

Por ello, se ha buscado como establecer un m√≥dulo en nuestro proyecto de servidor Oauth, y se ha encontrado un repositorio en github. Entonces, en nuestro servidor levantaremos ambos servidores.

He estado probando la configuraci√≥n, y el repo del servidor OAuth est√° un poco verde, por lo que habr√≠a que reajustar ciertos aspectos como cambiar como se hace la verificaci√≥n de las cuentas (con los valores de nuestra BD), o la generaci√≥n y borrado de tokens.

Se ha dejado medio planteado para su implantaci√≥n, al igual que se ha levantado en el servidor un 'intercepteador' de peticiones, para que compruebe en ese punto si esa petici√≥n es v√°lida o no, en funcion de la URI o el token.

Esta desarrollado aunque no funcione de momento, pero porque se dejar√° para m√°s adelante, para seguir la lista de milestones por orden.

---

## S√°bado 19 de Octubre

Despu√©s de organizar el trabajo y redactar los informes anteriores, procedo a preparar una actividad que autom√°ticamente recopile los datos.
Para ello se ha creado un singleton que es ejecutado al iniciar el servidor, que har√° de cach√©. Desde √©l, se le puede pedir recargar cierto pueblo, y en un futuro, otras acciones y labores que requieran un acceso a internet.

En cuanto a la automatizaci√≥n de tareas por parte del servidor, se ha encontrado que toda raspberry cuenta con `crontab`, que srive para automatizar tareas. Es muy util esto para estableer tareas que se ejecuten cada ves que se reinicie el dispositivo.

En este caso, nos interesa que se ejecute el script que realice las labores de `I'M ALIVE!` as√≠ que se establecer√° la l√≥gica de estas peticiones, y se podnr√°n en marcha con:

```zsh
@reboot python /home/pi/assistant-logic.py &
```

---

## Domingo 20 de Octubre

Organizo bien todos los repositorios e intento que se ejecute el script de inicio con crontable, pero no parece funcionar bien.
El script que se envia cada 5 minutos s√≠ que funciona, y tendr√© que modificarlo para usarlo de controlador y dotarlo de funciones.

Me doy cuenta que **el dispositivo no responde si hacemos un reboot**.

Creo las clases que vamos a utilizar en la base de datos y tambi√©n creo un frontend para el login con vuejs.
No puedo probarlo por que el servidor no permite acceder a √©l desde fuera, asi que mando un correo para que me lo abran.

---

## Lunes 21 de Octubre

Me abren el puerto:
65141 --> ssh
65142 --> 80 para el front
65143 --> 8082 para el core

Despliego el login con unos √∫ltimos retoques del front y ya es accesible.

## Martes 22 de Octubre
Intento instalar la [base de datos](https://tecadmin.net/install-postgresql-server-on-ubuntu/) en el servidor, para poder desplegar el core:

1. Obtengo la clave y recursos de postgres:

```zsh
$ sudo apt-get install wget ca-certificates
.... obtengo los certificados

$ wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
.... a√±ado la clave de postgres

$ sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main" >> /etc/apt/sources.list.d/pgdg.list'
.... lo configuro
```

2. Instalo el servidor:

```zsh
$ sudo apt-get update
.... actualizo los paquetes

$ sudo apt-get install postgresql postgresql-contrib
.... los instalo
```

3. Accedo a √©l:

```zsh
$ sudo su - postgres
.... entro con el usuario de postgres

$ psql
.... me conecto a la consola
```

Ahora procedo a crear una base de datos:

```psql
postgres@psql> CREATE DATABASE assistant;
```

Me responde: _CREATE DATABASE_ por lo que se ha creado. Podemos verla con `\l`.
Y podemos entrar a ella con:

```psql
postgres@psql> assistant
```

La creaci√≥n de todas las tablas se la vamos a dejar a Kotlin, con el framework de exposed, que es muy √∫til.
Una vez visto esto, procedemos a desplegar el core en el servidor.

Para poder conectar nuestro core con la base de datos necesitamos un usuario y contrase√±a, para ello redefinimos la contrase√±a de postgres entrado dentro y alterando el usuario:

```psql
postgres@psql> ALTER USER postgres PASSWORD 'nueva_contrase√±a';
```

En el core, ponemos la configuraci√≥n de la base de datos y el puerto espec√≠fico, que en este caso es el 5432, el que se usa por defecto en postgres.

Lanzamos el core y vemos que funciona perfectamente haciendo la petici√≥n en local:

```zsh
$ curl localhost:8082/test/SANVICENTEDELPALACIO
{
  "status": "ALIVE",
  "places": [
    {
      "address": {
        "name": "Ayuntamiento de San Vicente del Palacio",
        "street": "Plaza Mayor, 1.",
        "postalcode": "47493",
        "city": "San Vicente del Palacio. Valladolid"
      },
      "telephone": "+34 983 825 006",
      "fax": "+34 983 825 056",
      "email": "ayuntamiento@sanvicentedelpalacio.gob.es",
      "urlExterna": "http://sanvicentedelpalacio.gob.es"
    }
  ]
}
```

Pero no conseguimos respuesta en `http://virtual.lab.infor.uva.es:65143/test/SANVICENTEDELPALACIO`, por lo que a√∫n no nos han configurado la pasarela para acceder desde fuera.

Se retrasa la configuraci√≥n del login y del frontend debido a que no se puede establecer la conexi√≥n.

---

## Mi√©rcoles 23 de Octubre

AL parece le hab√≠a solicitado otro puerto, por lo que lo estaba indexando al que no era. Ya me lo ha cambiado al que era y s√≠ que funciona.

Como ya ponemos comprobar la autenticaci√≥n, generaremos el esquema de estilo de las respuestas y peticiones que lanzaremos:
  > **[get] url:65143/alive**
  
  - response:

  ```zsh
  {
    status : 200,
    action : "ALIVE",
    data : {
      next_action: null, # null / next action
      config: JSON # configuration for the next_action
    }
  }
  ```

  > **[post] url:65143/towns/{town}**

- **post: /towns/{town}**:
  - request:

  ```zsh
  {
    data : {
      from: String, # date time in ISO: YYYY-MM-DDTHH-MM-SS
    }
  }
  ```

  - response:

  ```zsh
  {
    status: 200,
    data : {
      content : [
        {
          address: {
            name: String,
            street: String,
            postalcode: Int,
            city: String
          },
          telephone: String,
          fax: String,
          email: String,
          urlExterna: String
        }
      ]
    }
  }
  ```

  Con el puerto ya establecido, intento una conexi√≥n entre el dispositivo y el servidor, funcionando de manera correcta, pero no consigo que se inicie automaticamente al reiniciar el dispositivo.

  Tras dos horas de intenso trabajo y b√∫squeda de informaci√≥n, acabo encontrar [por qu√© no funciona](https://www.digitalocean.com/community/questions/unable-to-execute-a-python-script-via-crontab-but-can-execute-it-manually-what-gives) **cron**, y es, al aprecer, que no sabe leer bien las rutas.

  Tambi√©n, hago que se inicie autom√°ticamente el servicio de cron, a√±adiendo en `/etc/rc.local`, antes del '`exit 0`' la siguiente l√≠nea.
  
  ```
  /etc/init.d/cron start
  ```

  Procedo a utilizar el siguiente c√≥digo (entrando con `$ crontab -e`), con el que finalmente sabe situarse, y funcionar:
  
  ```cron
  @reboot sleep 60; cd /home/pi/assistant.task/src/ ; /usr/bin/python /home/pi/assistant.task/src/assistant-alive.py & > logfile.txt"
  ```

---

## Jueves 24 de Octubre

Como ya funciona correctamente lo de ejecutar un script al reiniciarse, toca hacer el planning de **QU√â se ejecuta**, y en **QU√â orden**.

- El usuario y contrase√±a de la raspberry _[hidden]_. De esta forma, se podr√° descifrar en el lado del servidor y servir√° para todas.

  1.  [LOGIN] : intenta iniciar sesi√≥n.

      [LISTENER] : Escucha al servidor MQTT apuntando lo que salga que no sea cogido por ningun intent _(no estoy seguro de que aparezca si no hay intent)_

``` zsh
[Login] Recibe HTTP 200:  inicia [RETRIEVER]
                          inicia [SENDER]
                          inicia [ALIVE].
```

> [RETRIEVER] Recibe :(401/500) = muere. 200 = elimina los ficheros.

> [SENDER] igual que RETRIEVER.

> [ALIVE] Si recibe un 401/500, lanza [LOGIN] y muere. Si recibe un (200;ALIVE), espera y vuelve a mandar petici√≥n. Si recibe un (200;REBOOT) avisa de que se va a reiniciar y se reinicia.

Por tanto, una vez planificado, vamos a darle ca√±a.

---

## Viernes 25 de Octubre

Vamos a ver como podemos obtener la direcci√≥n MAC del dispositivo, extray√©ndolo:

```zsh
$ ifconfig | grep ether
  ether XX:XX:XX:XX:XX:XX
  ether XX:XX:XX:XX:XX:XX
```

De este modo, podemos extraerla y guardarla en un fichero.

```python
import os;
import time;

macfile = "macfile.txt"
comando = "ifconfig | grep ether > " + macfile

os.system(comando) # execute command

time.sleep(2) # wait to do more safe

with open(macfile, "r") as file: # open file to read it
    data = file.readline().replace('ether', '').replace("\t", '').replace("\n", '').replace(" ", '')

with open(macfile, "w") as file: # open the same file to save the MAC
    file.write(data)
```

De esta forma obtenemos un fichero `macfile.txt` donde tenemos registrada la direcci√≥n mac.

Las contrase√±a se encriptar√° con el n√∫mero: _42,503_.

---

## Domingo 27 de Octubre

Configuramos el servicio de login de administradores por parte del sistema, de modo que introduciendo sus datos, se le creen los tokens necesarios.

> [POST] http://virtual.lab.infor.uva.es:65143/worker/login

```json
{
	"user": "admin",
	"password" : "laquesea"
}
```

Y de tal env√≠o, recibimos la respuesta del servidor

```json
{
  "access_token": "Bearer aOs3eHPQfa3zMpRdhIyGQ2TbWSYCZgK1",
  "refresh_token": "Bearer Ddk3T6Cxyu5fmghAgBMcxNQnHkZNsmRz"
}
```

Para filtrar las URI p√∫blicas y privadas, se ha creado `src/config/GrantAccess.kt` quien permite acceso a una determinada URI en funcion del tipo de usuario que es, y ese usuario se comprueba a trav√©s del identificador asociado a sus tokens.

---

## Lunes 27 de Octubre

Se ha modificado el m√©todo de login de los dispositivos, de modo que al solicitar los tokens, se comprueba si la contrase√±a es corracta sin necesidad de acceder a la base de datos. Una vez comprobada, se guarda el dispositivo en la base de datos en caso de que nunca hubiese sido registrado y se a√±ade una nueva fila a la tabla **status**, informando de qu√© dispositivo se ha conectado con petici√≥n de _login_, y a qu√© hora.

---

## Martes 28 de Octubre

Se intenta crear un servicio que obtenga todos los dispositivos si eres un trabajador, pero no se consigue hacer funcionar.
Al final el fallo es que se estaba decodificando mal la contrase√±a de los dispositivos y por un fallo dec√≠a que era correcta, de modo que no se llegaban a registrar. Una vez solucionado, se a√±aden perfectamente en el registro.

Se termina el servicio de recogida de todos los dispositivos mediante un usuario autenticado, y funciona perfectamente. De este modo, se verifica que est√° bien configurado el OAuth, y funcionando.

Ya tenemos el servicio rest levantado para poder mostrar los dispositivos en la web de administraci√≥n, con informaci√≥n acerca de su ultima conexi√≥n.

> [get] http://virtual.lab.infor.uva.es:65143/worker/devices

```json
[
    {
        "device": "b8:27:eb:33:78:eb",
        "state": "LOGIN",
        "timestamp": "2019-10-29T20:02:47.435Z"
    }
]
```

## Hasta el Martes 6 de Noviembre

Se crean los servicios Web necesarios para **crear a personas**, relacionarlas con dispositivos espec√≠ficos, y se desarrolla la web hasta dejar operativa una versi√≥n de prueba en la que aparecen los dispositivos registrados y a qui√©n est√°n asignados, al igual que una m√°s interactiva respuesta de forma que cambia el color del dispositivo en funci√≥n de cu√°nto tiempo lleva sin conectarse al sistema.
_(As√≠ escrito parece poco, pero ha sido mucho trabajo._)

---

## Martes 6 de Noviembre

Hoy nos vamos a dentrar en la programaci√≥n orientada a objetos en python, ya que la desconozco y con esto podr√≠amos mejorar los servicios y expansibilidad de las funciones en la parte del dispositivo.
Se ha estado trasteando y se ha conseguido cambiar la estructura de la parte del dispositivo, de una manera m√°s orientada a objetos, y ahora el dispositivo es capaz de iniciar sesion, conectarse al sistema y enviar ping al servidor de manera autom√°tica con tan solo conectarlo a corriente, **siempre y cuando tenga una red wifi configurada**.

---

## Miercoles 7 de Noviembre

Se ha cambiado al configuraci√≥n del backend a la hora de autenticar usuarios, ya que se encontr√≥ un error a la hora de diferenciar a administradores y dispositivos por sus access tokens, al utilizar el mismo servidor OAuth. Ya ha sido reparado.

---

## Jueves 8 de Noviembre

Se ha empezado la parte del front en la que se puede a√±adir usuarios al sistema, pero falta refinar la especificaci√≥n:

 > asignar a un usuario un CP en vez de un pueblo, y a cada pueblo sus CP, asi realizamos las acciones en funcion de CP.

 Este cambio nos hace cambiar al estructura del core y sus tablas.

## Domingo 10 de Noviembre

Antes de finalizar la parte de a√±adir usuarios se va a realizar la de a√±adir pueblos y su c√≥digo postal, ya que es requerido en la creaci√≥n de los usuarios

---

# üìç Milestones

- [x] Conseguir que detecte lo escuchado - **30/09/2019**
- [x] Conseguir que hable ingl√©s - **01/10/2019**
- [x] Conseguir que hable - **01/10/2019**
- [x] Conseguir que hable castellano - **04/10/2019**
- [x] Cambiar hotword - **13/10/2019**
- [ ] Tarjeta sim en vez de wifi.
- [X] Estable el audio con fuentes de alimentaci√≥n diferentes. **29/10/2019**
- [X] Crear una cach√© en el servidor para unas respuestas m√°s rapidas. **19/10/2019**
- [X] Configurar servidor de la escuela. **20/10/2019**
- [X] Automatizar las peticiones `I'm alive!` del dispositivo. **23/10/2019**
- [X] Generar un usuario y contrase√±a para cada dispositivo. **27/10/2019**
- [X] protocolo OAuth. **28/10/2019**
- [X] DB para guardar el estado de cada dispositivo. **28/10/2019**
- [X] FRONTEND con inicio de sesi√≥n **29/12/2019**
- [X] FRONTEND para ver el estado de cada dispositivo. **3/11/2019**
- [X] BACKEND para crear usuarios **04/11/2019**
- [X] BACKEND para relacionar usuarios y dispositivos **05/11/2019**
- [X] Dispositivo: POO **06/11/2019**
- [X] Dispositivo arranca y autom√°ticamente se inicia sesi√≥n, o se crea un usuario si no est√° creado, y se mantienen enviando pings cada 5 minutos. **06/11/2019**
- [X] FRONTEND para crear usuarios
- [X] FRONTEND para relacionar usuarios y dispositivos
- [ ] Servidor HTTPS
- [ ] Registro de estad√≠sticas en la parte del dispositivo.
- [ ] Env√≠o de estad√≠sticas al servidor.
- [ ] Mostrar estad√≠sticas en la web.
- [ ] Mensaje de bienvenida al iniciar el dispositivo.
- [ ] Servidor manda acciones al dispositivo en el cuerpo de las respuestas al `I'm alive`. _(Reboot)_
- [ ] Dispositivo realiza las acciones que le manda el servidor. _(Reboot)_
- [ ] arranque de la m√°quina: que hable al encenderse.
- [ ] Conseguir di√°logo simple con el dispositivo.
- [ ] Configurar el wifi con el di√°logo.
